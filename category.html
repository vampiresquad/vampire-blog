<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vampire's Media Hub - Category</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Reading Progress -->
    <div id="reading-progress"></div>

    <!-- Header -->
    <header class="site-header">
        <div class="nav-container">
            <a href="index.html" class="logo">Vampire<span>'s</span> Hub</a>
            <nav class="main-nav">
                <a href="index.html">Home</a>
                <a href="about.html">About</a>
                <a href="search.html">Search</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <section class="page-header">
            <h1 id="category-title">Category</h1>
        </section>

        <section class="post-grid" id="post-container">
            <!-- Initial Skeleton Loader -->
            <article class="skeleton-card">
                <div class="skeleton-card-content">
                    <div class="skeleton skeleton-line h-20"></div>
                    <div class="skeleton skeleton-line h-12"></div>
                    <div class="skeleton skeleton-line h-16"></div>
                    <div class="skeleton skeleton-line h-16-75"></div>
                    <div class="skeleton skeleton-line h-16-50" style="margin-top:1rem;"></div>
                </div>
            </article>
            <article class="skeleton-card">
                <div class="skeleton-card-content">
                    <div class="skeleton skeleton-line h-20"></div>
                    <div class="skeleton skeleton-line h-12"></div>
                    <div class="skeleton skeleton-line h-16"></div>
                    <div class="skeleton skeleton-line h-16-75"></div>
                    <div class="skeleton skeleton-line h-16-50" style="margin-top:1rem;"></div>
                </div>
            </article>
        </section>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <p>&copy; 2025 - Vampire's Media Hub. All rights reserved.</p>
    </footer>

    <!-- JS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GITHUB_USERNAME = 'vampiresquad';
            const GITHUB_REPONAME = 'vampire-blog';
            const POSTS_PER_PAGE = 9;

            const postContainer = document.getElementById('post-container');
            const categoryTitle = document.getElementById('category-title');
            const progressBar = document.getElementById('reading-progress');

            let page = 1;
            let isLoading = false;
            let hasMore = true;

            // --- Get Label from URL ---
            const params = new URLSearchParams(window.location.search);
            const label = params.get('label') || 'general';
            categoryTitle.textContent = label.charAt(0).toUpperCase() + label.slice(1);

            // --- Fetch Posts ---
            async function fetchPosts() {
                if(isLoading || !hasMore) return;
                isLoading = true;

                const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPONAME}/issues?state=open&labels=${label}&sort=created&direction=desc&per_page=${POSTS_PER_PAGE}&page=${page}`;

                try {
                    const response = await fetch(apiUrl);
                    if(!response.ok) throw new Error(`${response.status} ${response.statusText}`);
                    const issues = await response.json();

                    if(issues.length < POSTS_PER_PAGE) hasMore = false;

                    if(page === 1) postContainer.innerHTML = '';
                    if(issues.length === 0 && page === 1){
                        postContainer.innerHTML = `<p style="grid-column:1/-1;text-align:center;">No posts found for "${label}"</p>`;
                    }

                    issues.forEach(issue => {
                        const postCard = document.createElement('div');
                        postCard.innerHTML = createPostCard(issue);
                        postCard.classList.add('fade-in');
                        postContainer.appendChild(postCard.firstElementChild);
                    });

                    page++;
                    isLoading = false;
                } catch(err) {
                    console.error('Error fetching posts:', err);
                    postContainer.innerHTML = `<p style="text-align:center;color:#ff4d4d;grid-column:1/-1;">Failed to load posts. ${err.message}</p>`;
                }
            }

            // --- Create Post Card ---
            function createPostCard(issue){
                const postDate = new Date(issue.created_at).toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'});
                const snippet = issue.body ? issue.body.substring(0,150)+'...' : 'No description available.';
                let tagsHTML = '';
                issue.labels.forEach(label=>{
                    const exclude = ['bug','documentation','duplicate','enhancement','good first issue','help wanted','invalid','question','wontfix'];
                    if(!exclude.includes(label.name.toLowerCase())){
                        tagsHTML += `<span class="post-tag" style="background-color:#${label.color}30;color:#${label.color};">${label.name}</span>`;
                    }
                });
                return `
                    <article class="post-card">
                        <div class="post-card-content">
                            <h2><a href="post.html?id=${issue.number}">${issue.title}</a></h2>
                            <div class="post-meta">Posted by ${issue.user.login} on ${postDate}</div>
                            <div class="post-tags">${tagsHTML}</div>
                            <p class="post-excerpt">${snippet}</p>
                            <a href="post.html?id=${issue.number}" class="read-more">Read More â†’</a>
                        </div>
                    </article>
                `;
            }

            // --- Infinite Scroll ---
            window.addEventListener('scroll', () => {
                const scrollTop = window.scrollY;
                const docHeight = document.body.scrollHeight - window.innerHeight;
                const scrolled = (scrollTop / docHeight) * 100;
                progressBar.style.width = scrolled + "%";

                if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 300){
                    fetchPosts();
                }
            });

            // --- Init ---
            fetchPosts();
        });
    </script>

    <style>
        /* Fade-in Animation */
        .fade-in { animation: fadeInUp 0.6s ease forwards; opacity:0; }
        @keyframes fadeInUp {
            from { transform:translateY(20px); opacity:0; }
            to { transform:translateY(0); opacity:1; }
        }
    </style>
</body>
</html>
