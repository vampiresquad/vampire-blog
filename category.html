<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vampire's Media Hub - Category</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="reading-progress"></div>

  <header class="site-header">
    <div class="container nav-container">
      <a class="logo" href="index.html">Vampire<span>'s</span> Hub</a>
      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="search.html">Search</a>
        <a href="about.html">About</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="page-header"><h1 id="category-title">Category</h1></section>
    <section class="post-grid" id="post-container">
      <article class="skeleton-card"><div class="skeleton-card-content"><div class="skeleton-line h-20 skeleton"></div><div class="skeleton-line h-12 skeleton"></div></div></article>
      <article class="skeleton-card"><div class="skeleton-card-content"><div class="skeleton-line h-20 skeleton"></div><div class="skeleton-line h-12 skeleton"></div></div></article>
    </section>
  </main>

  <footer class="site-footer"><p>&copy; 2025 Vampire's Media Hub</p></footer>

  <script>
  (function(){
    const GITHUB_USERNAME = 'vampiresquad';
    const GITHUB_REPONAME = 'vampire-blog';
    const PER_PAGE = 8;
    const params = new URLSearchParams(window.location.search);
    const label = params.get('label') || '';
    document.getElementById('category-title').textContent = label ? label.replace(/-/g,' ') : 'All';

    const container = document.getElementById('post-container');
    let page = 1, loading=false, exhausted=false;

    async function fetchPosts(){
      if(loading||exhausted) return;
      loading=true;
      const api = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPONAME}/issues?state=open&labels=${encodeURIComponent(label)}&sort=created&direction=desc&per_page=${PER_PAGE}&page=${page}`;
      try{
        const res = await fetch(api);
        if(!res.ok) throw new Error(res.statusText);
        const list = await res.json();
        if(page===1) container.innerHTML='';
        if(!Array.isArray(list) || list.length===0){
          exhausted=true;
          if(page===1) container.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#ff6b6b">No posts in ${label}</p>`;
          loading=false; return;
        }
        list.forEach(issue=>{
          const el = document.createElement('div');
          el.innerHTML = createPostCard(issue);
          el.firstElementChild.classList.add('fade-in');
          container.appendChild(el.firstElementChild);
        });
        if(list.length<PER_PAGE) exhausted=true;
        page++;
      }catch(e){
        console.error(e);
        if(page===1) container.innerHTML=`<p style="grid-column:1/-1;text-align:center;color:#ff6b6b">Failed to load posts.</p>`;
      }
      loading=false;
    }

    function createPostCard(issue){
      const date = new Date(issue.created_at).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
      const snippet = issue.body? issue.body.slice(0,160).replace(/[\r\n]+/g,' ') + '...' : 'No description';
      let tags='';
      (issue.labels||[]).forEach(l=>{
        if(!['bug','documentation','duplicate','enhancement','good first issue','help wanted','invalid','question','wontfix'].includes(l.name.toLowerCase())) tags += `<span class="post-tag">${l.name}</span>`;
      });
      return `
        <article class="post-card">
          <div class="post-card-content">
            <h2><a href="post.html?id=${issue.number}">${issue.title}</a></h2>
            <div class="post-meta">${date} • ${issue.user.login}</div>
            <div class="post-tags">${tags}</div>
            <p class="post-excerpt">${snippet}</p>
            <a class="read-more" href="post.html?id=${issue.number}">Read More →</a>
          </div>
        </article>
      `;
    }

    // infinite scroll
    window.addEventListener('scroll', ()=>{
      if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 220) fetchPosts();
      // progress
      const total = document.body.scrollHeight - window.innerHeight;
      const pct = (window.scrollY/total)*100;
      document.getElementById('reading-progress').style.width = pct + '%';
    });

    fetchPosts();
  })();
  </script>
</body>
</html>
